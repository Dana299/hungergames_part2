<!DOCTYPE html>
{% extends 'base.html' %}

{% block content %}
    <div class="container mt-4">

        <h1 id="fullURL"></h1>
        <hr>

        <div id="resource-container">
            <div class="col-md-6 mb-6">
                <div class="card bg-light mb-3">
                    <div class="card-header">
                        <p>Информация об обработке файла</p>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">

                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const requestID = window.location.href.split('/').reverse()[0];

            getWebResourceData(requestID);
        });

        function getWebResourceData(requestID) {
            var xhr = new XMLHttpRequest();

            xhr.open('GET', '/api/processing-requests/' + requestID);
            console.log(requestID);

            xhr.onload = function () {
                if (xhr.status === 200) {
                    var resourceData = JSON.parse(xhr.responseText);
                    // display response data and pagination block
                    displayResourceData(resourceData);

                } else {
                    console.error('Ошибка при получении данных об обработке заявки:', xhr.status);
                }
            };

            xhr.onerror = function () {
                console.error('Ошибка при выполнении запроса');
            };

            xhr.send();
        }

        function displayResourceData(resourceData) {
            const cardListElement = document.getElementsByClassName("list-group-flush")[0]
            const errors = resourceData.errors;

            const statusElement = document.createElement('li')
            statusElement.classList.add("list-group-item")

            if (resourceData.status === "in_process") {
                var statusText = "в обработке"
            } else if (resourceData.status === "pending") {
                statusText = "в очереди на обработку"
            } else if (resourceData.status === "succeeded") {
                statusText = "завершена"
            }

            statusElement.textContent = `Статус обработки: ${statusText}`
            cardListElement.appendChild(statusElement)

            const totalNumberElement = document.createElement('li')
            totalNumberElement.classList.add("list-group-item")
            totalNumberElement.textContent = `Строк в файле: ${resourceData.total}`
            cardListElement.appendChild(totalNumberElement)

            const processedNumberElement = document.createElement('li')
            processedNumberElement.classList.add("list-group-item")
            processedNumberElement.textContent = `Обработано строк в файле: ${resourceData.processed}`
            cardListElement.appendChild(processedNumberElement)

            const errorNumberElement = document.createElement('li')
            errorNumberElement.classList.add("list-group-item")
            errorNumberElement.textContent = `Число строк с невалидными ссылками: ${errors.count}`
            cardListElement.appendChild(errorNumberElement)

            if (errors.count > 0) {
                const errorListElement = document.createElement('li');
                errorListElement.classList.add("list-group-item")

                errors.error_urls.forEach(errorUrl => {
                    const listItem = document.createElement('li');
                    listItem.textContent = errorUrl;
                    errorListElement.appendChild(listItem);
                });

                cardListElement.appendChild(errorListElement)
            }

        }

    </script>
{% endblock %}
