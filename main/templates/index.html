<!DOCTYPE html>
{% extends 'base.html' %}

{% block content %}
    <div class="container mt-4">
        <table class="table table-bordered align-middle table-hover p-3" id="resources-table">
            <thead class="bg-dark"></thead>
        </table>

        <nav aria-label="...">
            <ul class="pagination pagination-circle justify-content-center d-flex">
              <li class="page-item">
                <a class="page-link" id="previous-link" onclick="navigateToPreviousPage(event)">Предыдущая страница</a>
              </li>

              <div id="pagination-numbers" class="d-flex"></div>

              <li class="page-item">
                <a class="page-link" id="next-link" onclick="navigateToNextPage(event)">Следующая страница</a>
              </li>
            </ul>
          </nav>

    </div>



<script>

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);

        const page = urlParams.get('page')
        const perPage = urlParams.get('per_page')

        getWebResources(page, perPage);
      });

    function getWebResources(page, perPage) {
        var xhr = new XMLHttpRequest();

        xhr.open('GET', '/api/resources/?page=' + page + '&per_page=' + perPage);

        xhr.onload = function() {
        if (xhr.status === 200) {
            var data = JSON.parse(xhr.responseText);
            // display response data and pagination block
            displayResources(data.items);
            displayPagination(data);

        } else {
            console.error('Ошибка при получении веб-ресурсов:', xhr.status);
        }
        };

        xhr.onerror = function() {
            console.error('Ошибка при выполнении запроса');
        };

        xhr.send();
    }

    function displayResources(resources) {
        const table = document.getElementById('resources-table');

        table.innerHTML = '';

        // Create table header
        const tableHeader = document.createElement('thead');
        const headerRow = document.createElement('tr');
        const headers = ['Полный адрес', 'Домен', 'Доменная зона', 'Последний код ответа'];

        headers.forEach(headerText => {
            const header = document.createElement('th');
            header.setAttribute('scope', 'col')
            header.textContent = headerText;
            headerRow.appendChild(header);
        });

        headerRow.style = "text-align: center; vertical-align: middle";

        tableHeader.appendChild(headerRow);
        table.appendChild(tableHeader);

        // Create table body
        const tableBody = document.createElement('tbody');

        resources.forEach(resource => {
            const row = document.createElement('tr');

            // Create cells for each field
            const fullUrlCell = document.createElement('td');
            const link = document.createElement('a');
            link.href = '/resources/' + resource.uuid;
            link.textContent = resource.full_url;
            fullUrlCell.appendChild(link);
            row.appendChild(fullUrlCell);

            const domainCell = document.createElement('td');
            domainCell.textContent = resource.domain;
            domainCell.style = "text-align: center; vertical-align: middle";
            row.appendChild(domainCell);

            const domainZoneCell = document.createElement('td');
            domainZoneCell.textContent = resource.domain_zone;
            domainZoneCell.style = "text-align: center; vertical-align: middle";
            row.appendChild(domainZoneCell);

            const statusCodeCell = document.createElement('td');
            statusCodeCell.textContent = resource.status_code;
            statusCodeCell.style = "text-align: center; vertical-align: middle";
            row.appendChild(statusCodeCell);

            if (resource.is_available === true) {
                row.classList.add("alert-success")
            } else if (resource.is_available === false) {
                row.classList.add("alert-danger")
            } else {
                row.classList.add("alert-info")
            }

            tableBody.appendChild(row);
        });

        table.appendChild(tableBody);

    }

    function displayPagination(data) {
        const previousLink = document.getElementById('previous-link')
        const nextLink = document.getElementById('next-link')
        const paginationContainer = document.getElementById("pagination-numbers")

        const currentPage = data.meta.page;
        const totalPages = data.meta.total_pages;

        // get `per_page` param from url
        const urlParams = new URLSearchParams(window.location.search);
        const perPage = urlParams.get('per_page')

        paginationContainer.innerHTML = '';

        // create pagination buttons
        for (let page = 1; page <= totalPages; page++) {
            const pageLink = createPaginationLink(`/resources/?page=${page}&${perPage}`, page);
            if (page === currentPage) {
                pageLink.classList.add('active');
            }
            paginationContainer.appendChild(pageLink);
        }

        previousLink.href = data.links.prev;
        nextLink.href = data.links.next;

        // add "disabled" to "Previous" button if there is no previous link
        if (!data.links.prev) {
            previousLink.parentElement.classList.add('disabled');
            } else if (data.links.prev) {
            previousLink.parentElement.classList.remove('disabled')
        }

        if (!data.links.next) {
            nextLink.parentElement.classList.add('disabled');
            } else if (data.links.next) {
            nextLink.parentElement.classList.remove('disabled')
        }

    }

    function createPaginationLink(url, text) {
        const li = document.createElement('li');
        li.classList.add('page-item');

        const link = document.createElement('a');
        link.classList.add('page-link');
        link.setAttribute('href', url);
        link.textContent = text;

        li.appendChild(link);
        return li;
    }

    function getPaginationQueryParamsFromUrl(url) {
        const queryString = url.split("?")[1]
        const urlParams = new URLSearchParams(queryString)

        const page = parseInt(urlParams.get('page'))
        const perPage = parseInt(urlParams.get('per_page'))

        return { page, perPage };
    }

    function navigateToNextPage(event) {
        event.preventDefault();
        const nextPageUrl = document.getElementById('next-link').getAttribute('href');
        const params = getPaginationQueryParamsFromUrl(nextPageUrl);
        const nextPage = params.page
        const perPage = params.perPage;

        getWebResources(nextPage, perPage);
    }

    function navigateToPreviousPage(event) {
        event.preventDefault();
        const previousPageUrl = document.getElementById('previous-link').getAttribute('href');
        const params = getPaginationQueryParamsFromUrl(previousPageUrl);
        const previousPage = params.page
        const perPage = params.perPage;

        getWebResources(previousPage, perPage);
    }

</script>
{% endblock %}
